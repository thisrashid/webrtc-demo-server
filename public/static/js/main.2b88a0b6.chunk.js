(this.webpackJsonpclient=this.webpackJsonpclient||[]).push([[0],{11:function(e,n,t){e.exports={App:"App_App__15LM-",AppHeader:"App_AppHeader__3Nt2M",Calling:"App_Calling__s5tkl",CallingMessage:"App_CallingMessage__8vYW5",CallingActions:"App_CallingActions__3pbvY",Accept:"App_Accept__1iRs5",Reject:"App_Reject__2yU0z"}},16:function(e,n,t){e.exports={VideoCall:"VideoCall_VideoCall__Md-QN",VideoCallDiv:"VideoCall_VideoCallDiv__33d1c",LocalVideo:"VideoCall_LocalVideo__3y-KR",RemoteVideo:"VideoCall_RemoteVideo__35n1f",CallActionDiv:"VideoCall_CallActionDiv__205Cm"}},26:function(e,n,t){e.exports={UserList:"UserList_UserList__2skpg"}},27:function(e,n,t){e.exports={Login:"Login_Login__7nyz_"}},34:function(e,n,t){},43:function(e,n,t){"use strict";t.r(n);var a=t(0),c=t.n(a),o=t(23),s=t.n(o),r=(t(34),t(3)),i=t(5),l=t(29),u=(t(42),t(2)),d={username:"",clientId:-1,users:[],messages:[],sockMsgs:[],endCall:!1};function f(e,n){var t;switch(n.type){case"SET_USER_NAME":return Object(i.a)(Object(i.a)({},e),{},{username:n.name});case"SET_USERS":return Object(i.a)(Object(i.a)({},e),{},{users:n.users});case"VIDEO_OFFER":return Object(i.a)(Object(i.a)({},e),{},{offer:n.message});case"INIT_RTC":return Object(i.a)(Object(i.a)({},e),{},{rtc:n.message,endCall:!1});case"ON_ANSWER":var a=new RTCSessionDescription(n.message);return null===(t=e.rtc)||void 0===t||t.connection.setRemoteDescription(a),Object(i.a)({},e);case"INIT_SOCKET":return Object(i.a)(Object(i.a)({},e),{},{socket:e.socket||n.message});case"ADD_ICE_CANDIDATE":var c;return null===(c=e.rtc)||void 0===c||c.connection.addIceCandidate(new RTCIceCandidate(n.message.candidate)),Object(i.a)(Object(i.a)({},e),{},{rtc:e.rtc});case"END_CALL":return Object(i.a)(Object(i.a)({},e),{},{endCall:!0});default:return console.error(e,n),e}}var j,b,p={actions:{},state:d},g=c.a.createContext(p),h=function(){return c.a.useContext(g)},O=t(8),m=t.n(O),v=t(13),C=t(24),_=t(25),x=function(e){if(!j)throw Error("WebSocket is not created. Please call 'createWebSocket' before this hook");e.username=e.username||b;var n=JSON.stringify(e);j.send(n)};function S(e){!function(e){var n=new Date;console.trace("["+n.toLocaleTimeString()+"] "+e)}("Error ".concat(e.name,": ").concat(e.message))}var E=function(){function e(n,t){var a=this;Object(C.a)(this,e),this.conn=void 0,this.username=void 0,this.targetUser=void 0,this.handleICECandidateEvent=function(e){e.candidate&&(e.candidate.candidate,x({type:"new-ice-candidate",target:a.targetUser,candidate:e.candidate}))},this.handleICEConnectionStateChangeEvent=function(){switch(a.conn.iceConnectionState,a.conn.iceConnectionState){case"closed":case"failed":case"disconnected":a.closeVideoCall()}},this.handleICEGatheringStateChangeEvent=function(){a.conn.iceGatheringState},this.handleSignalingStateChangeEvent=function(){switch(a.conn.signalingState,a.conn.signalingState){case"closed":a.closeVideoCall()}},this.handleNegotiationNeededEvent=Object(v.a)(m.a.mark((function e(){var n;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=1,e.next=5,a.conn.createOffer();case 5:if(n=e.sent){e.next=9;break}return console.log("Offer not created"),e.abrupt("return");case 9:if("stable"===a.conn.signalingState){e.next=12;break}return e.abrupt("return");case 12:return e.next=15,a.conn.setLocalDescription(n);case 15:x({name:a.username,target:a.targetUser,type:"video-offer",sdp:a.conn.localDescription}),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(1),S(e.t0);case 23:case"end":return e.stop()}}),e,null,[[1,19]])}))),this.handleTrackEvent=function(e){},this.closeVideoCall=function(){a.conn&&(a.conn.ontrack=null,a.conn.onicecandidate=null,a.conn.oniceconnectionstatechange=null,a.conn.onsignalingstatechange=null,a.conn.onicegatheringstatechange=null,a.conn.onnegotiationneeded=null,a.conn.getTransceivers().forEach((function(e){e.stop()})),a.conn.close())},this.username=n,this.targetUser=t;this.conn=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}]})}return Object(_.a)(e,[{key:"connection",get:function(){return this.conn}}]),e}(),k=t(16),w=t.n(k),A=t(1),N=function(){var e=Object(v.a)(m.a.mark((function e(n,t){var a,c;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=new RTCSessionDescription(t.offer),e.next=3,n.setRemoteDescription(a);case 3:return e.next=5,n.createAnswer();case 5:return c=e.sent,e.next=8,n.setLocalDescription(c);case 8:x({username:t.from,type:"send_answer",answer:c});case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),y=function(e){var n,t=e.target,a=e.join,o=e.onCallEnd,s=c.a.useState(),i=Object(r.a)(s,2),l=i[0],u=i[1],d=c.a.useState(),f=Object(r.a)(d,2),j=f[0],b=f[1],p=c.a.useState(!1),g=Object(r.a)(p,2),O=g[0],C=g[1],_=c.a.useState(!1),S=Object(r.a)(_,2),k=S[0],y=S[1],R=c.a.useState(!1),T=Object(r.a)(R,2),D=T[0],L=T[1],V=c.a.useState(!1),I=Object(r.a)(V,2),U=I[0],M=I[1],W=c.a.useState(!1),P=Object(r.a)(W,2),F=P[0],J=P[1],H=c.a.useState(),K=Object(r.a)(H,2),z=K[0],B=K[1],G=c.a.useState(),Y=Object(r.a)(G,2),q=Y[0],Q=Y[1],X=h(),Z=X.state,$=X.actions;window.state=Z,c.a.useEffect((function(){l&&(l.getVideoTracks()[0].enabled=F)}),[F,l]),c.a.useEffect((function(){l&&(l.getAudioTracks()[0].enabled=U)}),[U,l]);var ee=c.a.useCallback((function(){var e;(null===(e=Z.rtc)||void 0===e?void 0:e.connection)&&(Z.rtc.connection.ontrack=null,Z.rtc.connection.onicecandidate=null,Z.rtc.connection.oniceconnectionstatechange=null,Z.rtc.connection.onsignalingstatechange=null,Z.rtc.connection.onicegatheringstatechange=null,Z.rtc.connection.onnegotiationneeded=null,Z.rtc.connection.getTransceivers().forEach((function(e){e.stop()})),(null===z||void 0===z?void 0:z.srcObject)&&(z.pause(),z.srcObject.getTracks().forEach((function(e){e.stop()}))),Z.rtc.connection.close(),$.initRtc(void 0),x({type:"end_call",target:t}),o())}),[$,z,o,null===(n=Z.rtc)||void 0===n?void 0:n.connection,t]);return c.a.useEffect((function(){var e=function(){var e=Object(v.a)(m.a.mark((function e(n){var a;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.createOffer({});case 2:a=e.sent,x({target:t,type:"store_offer",offer:a}),n.setLocalDescription(a);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),n=function(){var e=Object(v.a)(m.a.mark((function e(n){var a,c;return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.getUserMedia({video:{frameRate:24,width:{min:480,ideal:720,max:1280},aspectRatio:1.33333},audio:!0});case 2:return a=e.sent,u(a),c=new E(Z.username,t),$.initRtc(c),Q(c.connection),a.getTracks().forEach((function(e){c.connection.addTrack(e,a)})),c.connection.ontrack=function(e){b(e.streams[0])},c.connection.onicecandidate="start"===n?function(e){null!=e.candidate&&x({target:t,type:"store_candidate",candidate:e.candidate})}:function(e){null!=e.candidate&&x({username:Z.offer.from,type:"send_candidate",candidate:e.candidate})},e.abrupt("return",c);case 11:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),c=function(){var t=Object(v.a)(m.a.mark((function t(){var a;return m.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n("start");case 2:a=t.sent,e(a.connection);case 4:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();a||O||(C(!0),c()),a&&!k&&(y(!0),n("join"))}),[Z.username,Z.offer,$,a,t,O,k]),c.a.useEffect((function(){Z.offer&&q&&!D&&(L(!0),N(q,Z.offer))}),[Z.offer,q,D,t]),c.a.useEffect((function(){Z.endCall&&ee()}),[Z.endCall,ee]),Object(A.jsxs)("div",{className:w.a.VideoCall,"data-testid":"VideoCall",children:[Object(A.jsx)("video",{className:w.a.LocalVideo,autoPlay:!0,ref:function(e){l&&e&&(e.srcObject=l,B(e))},muted:!0}),Object(A.jsx)("video",{className:w.a.RemoteVideo,autoPlay:!0,ref:function(e){j&&e&&(console.log("set remoteStream",e,j),e.srcObject=j)}}),Object(A.jsxs)("div",{className:w.a.CallActionDiv,children:[Object(A.jsxs)("button",{onClick:function(){return J(!F)},children:[F?"Play":"Pause"," Video"]}),Object(A.jsxs)("button",{onClick:function(){return M(!U)},children:[U?"Unmute":"Mute"," Audio"]}),Object(A.jsx)("button",{onClick:ee,children:"End Call"})]})]})},R=t(26),T=t.n(R),D=function(e){var n=e.user,t=e.onCallEnd,a=c.a.useState(""),o=Object(r.a)(a,2),s=o[0],i=o[1],l=h().state,u=c.a.useCallback((function(e){var n=e.currentTarget.dataset.name;n&&l.username!==n&&(console.log("Call user: ",n),i(n))}),[l.username]),d=c.a.useCallback((function(){i(""),t&&t(),console.log("Call ended")}),[t]);return c.a.useEffect((function(){i(n||"")}),[n]),s?Object(A.jsx)(y,{target:s,join:!!n,onCallEnd:d}):Object(A.jsx)("ul",{className:T.a.UserList,"data-testid":"UserList",children:l.users.map((function(e,n){return Object(A.jsx)("li",{"data-name":e,onClick:u,children:e},n)}))})},L=t(27),V=t.n(L),I=function(e){var n=e.onMessage,t=c.a.useState(""),a=Object(r.a)(t,2),o=a[0],s=a[1],i=c.a.useState(!1),l=Object(r.a)(i,2),d=l[0],f=l[1],p=h().actions,g=c.a.useCallback((function(e){s(e.target.value),p.setUserName(e.target.value)}),[p]),O=c.a.useCallback((function(){console.log("Connect");var e=function(e){return j=new window.WebSocket("wss://ra-webrtc.herokuapp.com/","json"),b=e,j.onopen=function(){console.log("WebSocket client connected")},j.onerror=function(e){return console.error("WebSocket error observed:",e)},j}(o);e.onerror=function(e){console.error("Error occurred: ",e)},e.onopen=function(){console.log("WebSocket client connected"),x({type:"store_user",username:o}),f(!0)},e.onmessage=n,p.initSocket(e)}),[n,p,o]);return d?Object(A.jsx)(u.a,{to:"/user-list"}):Object(A.jsxs)("div",{className:V.a.Login,"data-testid":"Login",children:[Object(A.jsx)("label",{children:"Username"}),Object(A.jsx)("input",{id:"name",type:"text",maxLength:12,required:!0,value:o,onChange:g,autoComplete:"username",inputMode:"text",placeholder:"Username"}),Object(A.jsx)("button",{onClick:O,children:"Login"})]})},U=t(11),M=t.n(U);function W(e){var n=e.children,t=Object(l.a)(e,["children"]),a=h().state;return Object(A.jsx)(u.b,Object(i.a)(Object(i.a)({},t),{},{render:function(e){var t=e.location;return a.username?n:Object(A.jsx)(u.a,{to:{pathname:"/login",state:{from:t}}})}}))}var P=function(){var e=c.a.useReducer(f,d),n=Object(r.a)(e,2),t=n[0],a=n[1],o=c.a.useState(!1),s=Object(r.a)(o,2),i=s[0],l=s[1],j=c.a.useState(!1),b=Object(r.a)(j,2),p=b[0],h=b[1],O=c.a.useMemo((function(){return function(e){return{setUserName:function(n){e({type:"SET_USER_NAME",name:n})},setUsers:function(n){e({type:"SET_USERS",users:n})},addIceCandidate:function(n){e({type:"ADD_ICE_CANDIDATE",message:n})},videoOffer:function(n){e({type:"VIDEO_OFFER",message:n})},answerVideo:function(n){e({type:"ANSWER_VIDEO",message:n})},initRtc:function(n){e({type:"INIT_RTC",message:n})},initSocket:function(n){e({type:"INIT_SOCKET",message:n})},onAnswer:function(n){e({type:"ON_ANSWER",message:n})},endCall:function(){e({type:"END_CALL"})}}}(a)}),[]);return Object(A.jsx)(g.Provider,{value:{state:t,actions:O},children:Object(A.jsxs)("div",{className:M.a.App,children:[Object(A.jsx)("header",{className:M.a.AppHeader,children:Object(A.jsx)("span",{children:"WebRTC Demo"})}),i&&!p&&Object(A.jsxs)("div",{className:M.a.Calling,children:[Object(A.jsxs)("div",{className:M.a.CallingMessage,children:[Object(A.jsxs)("b",{children:[i.from," Calling..."]}),Object(A.jsx)("audio",{src:"tmobile_wav.mp3",autoPlay:!0,loop:!0})]}),Object(A.jsxs)("div",{className:M.a.CallingActions,children:[Object(A.jsx)("button",{className:M.a.Accept,onClick:function(){h(!0)},children:"Accept"}),Object(A.jsx)("button",{className:M.a.Reject,onClick:function(){l(void 0)},children:"Reject"})]})]}),p?Object(A.jsx)(D,{user:i.from,onCallEnd:function(){h(!1),l(void 0)}}):Object(A.jsxs)(u.d,{children:[Object(A.jsx)(W,{path:"/user-list",children:Object(A.jsx)(D,{})}),Object(A.jsx)(u.b,{path:"*",children:Object(A.jsx)(I,{onMessage:function(e){var n=JSON.parse(e.data);switch(n.type){case"userlist":O.setUsers(n.users);break;case"answer":O.onAnswer(n.answer);break;case"candidate":O.addIceCandidate(n);break;case"offer":O.videoOffer(n),l(n);break;case"end_call":O.endCall();break;default:console.error("Unknown message received:",n)}}})})]})]})})},F=function(e){e&&e instanceof Function&&t.e(3).then(t.bind(null,44)).then((function(n){var t=n.getCLS,a=n.getFID,c=n.getFCP,o=n.getLCP,s=n.getTTFB;t(e),a(e),c(e),o(e),s(e)}))},J=t(19);s.a.render(Object(A.jsx)(c.a.StrictMode,{children:Object(A.jsx)(J.a,{children:Object(A.jsx)(P,{})})}),document.getElementById("root")),F()}},[[43,1,2]]]);
//# sourceMappingURL=main.2b88a0b6.chunk.js.map